{"version":3,"sources":["useStickyHeaderScrollProps.ts"],"names":["useEffect","useRef","Platform","runOnJS","scrollTo","useAnimatedReaction","useAnimatedRef","useSharedValue","useWorkletCallback","useResponsiveSize","VELOCITY_THRESHOLD","useStickyHeaderScrollProps","props","responsiveHeight","headerHeight","onMomentumScrollEnd","onScroll","onScrollEndDrag","onTopReached","parallaxHeight","snapStartThreshold","snapStopThreshold","snapToEdge","scrollValue","scrollViewRef","onTopReachedRef","onTopReachedWasCalled","current","maybeTopReached","value","scrollHeight","Math","max","onSnapToEdge","e","scrollToHeight","snapToEdgeThreshold","currentVal","velocity","y","dragsToTop","dragsToBottom","dragsQuickToBottom","dragsQuickToTop","isUnderSnapToEdgeThresholdAndDragIsSlow","isUnderSnapToEdgeThresholdAndDragIsQuick","isOverSnapToEdgeThresholdAndDragIsSlow","isOverSnapToEdgeThresholdAndDragIsQuick","onMomentumScrollEndInternal","onScrollEndDragInternal","OS","abs","onScrollInternal","contentOffset"],"mappings":"AAAA,SAASA,SAAT,EAAoBC,MAApB,QAAkC,OAAlC;AAEA,SAASC,QAAT,QAAyB,cAAzB;AACA,SACEC,OADF,EAEEC,QAFF,EAGEC,mBAHF,EAIEC,cAJF,EAKEC,cALF,EAMEC,kBANF,QAOO,yBAPP;AASA,SAASC,iBAAT,QAAkC,4BAAlC;AAQA,MAAMC,kBAAkB,GAAG,CAA3B;AAEA,OAAO,SAASC,0BAAT,CACLC,KADK,EAEL;AACA,QAAM;AAAEC,IAAAA;AAAF,MAAuBJ,iBAAiB,EAA9C;AAEA,QAAM;AACJK,IAAAA,YAAY,GAAG,GADX;AAEJC,IAAAA,mBAFI;AAGJC,IAAAA,QAHI;AAIJC,IAAAA,eAJI;AAKJC,IAAAA,YALI;AAMJC,IAAAA,cAAc,GAAGN,gBAAgB,CAAC,EAAD,CAN7B;AAOJO,IAAAA,kBAPI;AAQJC,IAAAA,iBARI;AASJC,IAAAA,UAAU,GAAG;AATT,MAUFV,KAVJ;AAYA,QAAMW,WAAW,GAAGhB,cAAc,CAAC,CAAD,CAAlC;AAEA,QAAMiB,aAAa,GAAGlB,cAAc,EAApC;AAEA,QAAMmB,eAAe,GAAGxB,MAAM,CAACiB,YAAD,CAA9B;AACA,QAAMQ,qBAAqB,GAAGzB,MAAM,CAAC,KAAD,CAApC;AAEAD,EAAAA,SAAS,CAAC,MAAM;AACdyB,IAAAA,eAAe,CAACE,OAAhB,GAA0BT,YAA1B;AACD,GAFQ,EAEN,CAACA,YAAD,CAFM,CAAT;;AAIA,WAASU,eAAT,CAAyBC,KAAzB,EAAwC;AACtC,QAAIA,KAAK,IAAI,CAAb,EAAgB;AACd,UAAI,CAACH,qBAAqB,CAACC,OAAvB,IAAkCF,eAAe,CAACE,OAAtD,EAA+D;AAC7DF,QAAAA,eAAe,CAACE,OAAhB;AACAD,QAAAA,qBAAqB,CAACC,OAAtB,GAAgC,IAAhC;AACD;AACF,KALD,MAKO;AACLD,MAAAA,qBAAqB,CAACC,OAAtB,GAAgC,KAAhC;AACD;AACF;;AAEDtB,EAAAA,mBAAmB,CACjB,MAAMkB,WAAW,CAACM,KADD,EAEhBA,KAAD,IAAW;AACT1B,IAAAA,OAAO,CAACyB,eAAD,CAAP,CAAyBC,KAAzB;AACD,GAJgB,EAKjB,CAACN,WAAD,CALiB,CAAnB;AAQA,QAAMO,YAAY,GAAGC,IAAI,CAACC,GAAL,CAASb,cAAT,EAAyBL,YAAY,GAAG,CAAxC,CAArB;AAEA,QAAMmB,YAAY,GAAGzB,kBAAkB,CACpC0B,CAAD,IAA0B;AAAA;;AACxB,UAAMC,cAAc,GAAGd,iBAAH,aAAGA,iBAAH,cAAGA,iBAAH,GAAwBS,YAA5C;AACA,UAAMM,mBAAmB,GAAGhB,kBAAH,aAAGA,kBAAH,cAAGA,kBAAH,GAAyBU,YAAY,GAAG,CAAjE;AAEA,UAAMO,UAAU,GAAGd,WAAW,CAACM,KAA/B;AACA,UAAMS,QAAQ,mCAAGJ,CAAC,CAACI,QAAL,gDAAG,YAAYC,CAAf,yDAAoB,CAAlC;AAEA,UAAMC,UAAU,GAAGF,QAAQ,IAAI,CAA/B;AACA,UAAMG,aAAa,GAAG,CAACD,UAAvB;AACA,UAAME,kBAAkB,GAAGD,aAAa,IAAIH,QAAQ,IAAI,CAAC5B,kBAAzD;AACA,UAAMiC,eAAe,GAAGH,UAAU,IAAIF,QAAQ,IAAI5B,kBAAlD;AAEA,UAAMkC,uCAAuC,GAC3CP,UAAU,GAAG,CAAb,IAAkBA,UAAU,GAAGD,mBAA/B,IAAsD,CAACM,kBADzD;AAEA,UAAMG,wCAAwC,GAC5CR,UAAU,IAAID,mBAAmB,GAAG,CAApC,IACAC,UAAU,GAAGD,mBADb,IAEAM,kBAHF;AAIA,UAAMI,sCAAsC,GAC1CT,UAAU,IAAID,mBAAd,IAAqCC,UAAU,GAAGF,cAAlD,IAAoE,CAACQ,eADvE;AAEA,UAAMI,uCAAuC,GAC3CV,UAAU,IAAID,mBAAd,IAAqCC,UAAU,GAAGF,cAAc,GAAG,CAAnE,IAAwEQ,eAD1E;;AAGA,QAAIrB,UAAJ,EAAgB;AACd;AACA;AACA,UAAIsB,uCAAuC,IAAIG,uCAA/C,EAAwF;AACtF3C,QAAAA,QAAQ,CAACoB,aAAD,EAAgB,CAAhB,EAAmB,CAAnB,EAAsB,IAAtB,CAAR;AACD,OAFD,MAEO,IACLsB,sCAAsC,IACtCD,wCAFK,EAGL;AACAzC,QAAAA,QAAQ,CAACoB,aAAD,EAAgB,CAAhB,EAAmBM,YAAnB,EAAiC,IAAjC,CAAR;AACD;AACF;AACF,GApCoC,EAqCrC,CAACV,kBAAD,EAAqBC,iBAArB,EAAwCS,YAAxC,EAAsDP,WAAtD,CArCqC,CAAvC;AAwCA,QAAMyB,2BAA2B,GAAGxC,kBAAkB,CACnD0B,CAAD,IAA0B;AACxBnB,IAAAA,mBAAmB,SAAnB,IAAAA,mBAAmB,WAAnB,YAAAA,mBAAmB,CAAGmB,CAAH,CAAnB;AACAD,IAAAA,YAAY,CAACC,CAAD,CAAZ;AACD,GAJmD,EAKpD,CAACnB,mBAAD,EAAsBkB,YAAtB,CALoD,CAAtD;AAQA,QAAMgB,uBAAuB,GAAGzC,kBAAkB,CAC/C0B,CAAD,IAA0B;AAAA;;AACxBjB,IAAAA,eAAe,SAAf,IAAAA,eAAe,WAAf,YAAAA,eAAe,CAAGiB,CAAH,CAAf;;AACA,QAAIhC,QAAQ,CAACgD,EAAT,KAAgB,SAAhB,IAA6BnB,IAAI,CAACoB,GAAL,mCAASjB,CAAC,CAACI,QAAX,iDAAS,aAAYC,CAArB,2DAA0B,CAA1B,IAA+B,CAAhE,EAAmE;AACjE;AACD;;AAEDN,IAAAA,YAAY,CAACC,CAAD,CAAZ;AACD,GAR+C,EAShD,CAACjB,eAAD,EAAkBgB,YAAlB,CATgD,CAAlD;AAYA,QAAMmB,gBAAgB,GAAG5C,kBAAkB,CACxC0B,CAAD,IAA0B;AACxBX,IAAAA,WAAW,CAACM,KAAZ,GAAoBK,CAAC,CAACmB,aAAF,CAAgBd,CAApC;AACAvB,IAAAA,QAAQ,SAAR,IAAAA,QAAQ,WAAR,YAAAA,QAAQ,CAAGkB,CAAH,CAAR;AACD,GAJwC,EAKzC,CAAClB,QAAD,CALyC,CAA3C;AAQA,SAAO;AACLD,IAAAA,mBAAmB,EAAEiC,2BADhB;AAELhC,IAAAA,QAAQ,EAAEoC,gBAFL;AAGLnC,IAAAA,eAAe,EAAEgC,uBAHZ;AAILnB,IAAAA,YAJK;AAKLP,IAAAA,WALK;AAMLC,IAAAA;AANK,GAAP;AAQD","sourcesContent":["import { useEffect, useRef } from 'react';\nimport type { FlatList, NativeScrollEvent, ScrollView, SectionList } from 'react-native';\nimport { Platform } from 'react-native';\nimport {\n  runOnJS,\n  scrollTo,\n  useAnimatedReaction,\n  useAnimatedRef,\n  useSharedValue,\n  useWorkletCallback,\n} from 'react-native-reanimated';\n\nimport { useResponsiveSize } from '../hooks/useResponsiveSize';\n\nimport type { StickyHeaderSharedProps, StickyHeaderSnapProps } from './StickyHeaderProps';\n\n// FIXME: unknown does not work here :/\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type ScrollComponent = ScrollView | FlatList<any> | SectionList<any, any>;\n\nconst VELOCITY_THRESHOLD = 7;\n\nexport function useStickyHeaderScrollProps<T extends ScrollComponent>(\n  props: StickyHeaderSharedProps & StickyHeaderSnapProps\n) {\n  const { responsiveHeight } = useResponsiveSize();\n\n  const {\n    headerHeight = 100,\n    onMomentumScrollEnd,\n    onScroll,\n    onScrollEndDrag,\n    onTopReached,\n    parallaxHeight = responsiveHeight(53),\n    snapStartThreshold,\n    snapStopThreshold,\n    snapToEdge = true,\n  } = props;\n\n  const scrollValue = useSharedValue(0);\n\n  const scrollViewRef = useAnimatedRef<T>();\n\n  const onTopReachedRef = useRef(onTopReached);\n  const onTopReachedWasCalled = useRef(false);\n\n  useEffect(() => {\n    onTopReachedRef.current = onTopReached;\n  }, [onTopReached]);\n\n  function maybeTopReached(value: number) {\n    if (value <= 0) {\n      if (!onTopReachedWasCalled.current && onTopReachedRef.current) {\n        onTopReachedRef.current();\n        onTopReachedWasCalled.current = true;\n      }\n    } else {\n      onTopReachedWasCalled.current = false;\n    }\n  }\n\n  useAnimatedReaction(\n    () => scrollValue.value,\n    (value) => {\n      runOnJS(maybeTopReached)(value);\n    },\n    [scrollValue]\n  );\n\n  const scrollHeight = Math.max(parallaxHeight, headerHeight * 2);\n\n  const onSnapToEdge = useWorkletCallback(\n    (e: NativeScrollEvent) => {\n      const scrollToHeight = snapStopThreshold ?? scrollHeight;\n      const snapToEdgeThreshold = snapStartThreshold ?? scrollHeight / 2;\n\n      const currentVal = scrollValue.value;\n      const velocity = e.velocity?.y ?? 0;\n\n      const dragsToTop = velocity >= 0;\n      const dragsToBottom = !dragsToTop;\n      const dragsQuickToBottom = dragsToBottom && velocity <= -VELOCITY_THRESHOLD;\n      const dragsQuickToTop = dragsToTop && velocity >= VELOCITY_THRESHOLD;\n\n      const isUnderSnapToEdgeThresholdAndDragIsSlow =\n        currentVal > 0 && currentVal < snapToEdgeThreshold && !dragsQuickToBottom;\n      const isUnderSnapToEdgeThresholdAndDragIsQuick =\n        currentVal >= snapToEdgeThreshold / 2 &&\n        currentVal < snapToEdgeThreshold &&\n        dragsQuickToBottom;\n      const isOverSnapToEdgeThresholdAndDragIsSlow =\n        currentVal >= snapToEdgeThreshold && currentVal < scrollToHeight && !dragsQuickToTop;\n      const isOverSnapToEdgeThresholdAndDragIsQuick =\n        currentVal >= snapToEdgeThreshold && currentVal < scrollToHeight / 2 && dragsQuickToTop;\n\n      if (snapToEdge) {\n        // TODO: when react-native-web will support onMomentumScrollEnd & onScrollEndDrag events\n        // handle web snap scroll\n        if (isUnderSnapToEdgeThresholdAndDragIsSlow || isOverSnapToEdgeThresholdAndDragIsQuick) {\n          scrollTo(scrollViewRef, 0, 0, true);\n        } else if (\n          isOverSnapToEdgeThresholdAndDragIsSlow ||\n          isUnderSnapToEdgeThresholdAndDragIsQuick\n        ) {\n          scrollTo(scrollViewRef, 0, scrollHeight, true);\n        }\n      }\n    },\n    [snapStartThreshold, snapStopThreshold, scrollHeight, scrollValue]\n  );\n\n  const onMomentumScrollEndInternal = useWorkletCallback(\n    (e: NativeScrollEvent) => {\n      onMomentumScrollEnd?.(e);\n      onSnapToEdge(e);\n    },\n    [onMomentumScrollEnd, onSnapToEdge]\n  );\n\n  const onScrollEndDragInternal = useWorkletCallback(\n    (e: NativeScrollEvent) => {\n      onScrollEndDrag?.(e);\n      if (Platform.OS === 'android' || Math.abs(e.velocity?.y ?? 0) > 0) {\n        return;\n      }\n\n      onSnapToEdge(e);\n    },\n    [onScrollEndDrag, onSnapToEdge]\n  );\n\n  const onScrollInternal = useWorkletCallback(\n    (e: NativeScrollEvent) => {\n      scrollValue.value = e.contentOffset.y;\n      onScroll?.(e);\n    },\n    [onScroll]\n  );\n\n  return {\n    onMomentumScrollEnd: onMomentumScrollEndInternal,\n    onScroll: onScrollInternal,\n    onScrollEndDrag: onScrollEndDragInternal,\n    scrollHeight,\n    scrollValue,\n    scrollViewRef,\n  };\n}\n"]}